---
name: E2E Test - Unamanged Cluster

on:
  repository_dispatch:
    types: [daily-build]

  workflow_dispatch:
  push:
    branches:
      - main
      - release-*
      - e2e-test-uc-2

    paths:
      - "**.go"
      - "cli/cmd/plugin/"
      - "**.sh"
      - ".github/workflows/e2e-unmanaged-cluster.yaml"
      - "**.md"
      - "Makefile"

    tags-ignore:
      - "**"

jobs:
  e2e-unmanaged-cluster-test:
    name: E2E Unmanaged Cluster Test
    runs-on: self-hosted
    steps:
      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: "1.17"
        id: go

      - name: Check out code
        uses: actions/checkout@v1

      - name: Install Ginkgo
        run: |
          go install -mod=mod github.com/onsi/ginkgo/v2/ginkgo
          go get github.com/onsi/gomega/...
          ginkgo version

      - name: Cleaning up Github Actions runner
        run: |
          df -h
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "/usr/local/share/boost"
          df -h

      - name: Run Unamanged Cluster E2E Test
        run: |
          mkdir -p ~/.config/tanzu/tkg/unmanaged/compatibility/
          echo 'version: v1
          unmanagedClusterPluginVersions:
          - version: v0.12.0-dev.1
            supportedTkrVersions:
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0-dev-2
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0-dev-1
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0
              - image: projects.registry.vmware.com/tce/tkr:v1.22.5
          - version: dev
            supportedTkrVersions:
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0-dev-2
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0-dev-1
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0
              - image: projects.registry.vmware.com/tce/tkr:v1.22.5
          - version: v0.11.0
            supportedTkrVersions:
              - image: projects.registry.vmware.com/tce/tkr:v0.17.0
              - image: projects.registry.vmware.com/tce/tkr:v1.22.5
          - version: v0.10.0
            supportedTkrVersions:
              - image: projects.registry.vmware.com/tce/tkr:v0.21.5' > 
          ~/.config/tanzu/tkg/unmanaged/compatibility/projects.registry.vmware.com_tce_compatibility_v4
          make unmanaged-cluster-e2e-test

      - name: Collect tanzu diagnostics data
        uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: diagnostics-data
          path: |
            bootstrap.*.diagnostics.tar.gz
            management-cluster.*.diagnostics.tar.gz
            workload-cluster.*.diagnostics.tar.gz
